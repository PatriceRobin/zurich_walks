---
title: "Impact of Covid on Cyclists and Pedestrians in Zurich"
author: "Patrice.Robin, Patrik.Widmer"
date: "1 2 2021"
output: pdf_document
number_sections: true
header-includes:
  - \usepackage[bottom]{footmisc} 
  - \usepackage{color}
---

<!-- %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->

\tableofcontents

<!-- %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->

<!-- Setting global options (hidden section) -->

<!-- Load packages (hidden section) -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE ,
                      message=FALSE,
                      warning = FALSE,
                      results = "hide"
                      )

```

```{r load packages}
# this line of code only runs, if these packages are required
if (!require(tidyverse)) {install.packages('"tidyverse"')}
if (!require(ggplot2)) {install.packages('ggplot2')}
if (!require(scales)) {install.packages('scales')}
if (!require(rgdal)) {install.packages('rgdal')}
if (!require(sf)) {install.packages('sf')}
if (!require(rasterVis)) {install.packages('rasterVis')}
if (!require(dplyr)) {install.packages('dplyr')}
if (!require(av)) {install.packages('av')}
if (!require(ggpubr)) {install.packages('ggpubr')}
if (!require(gdtools)) {install.packages('gdtools')}
if (!require(kableExtra)) {install.packages("kableExtra", dependencies = TRUE)}
if (!require(janitor)) {install.packages("janitor")}
if (!require(stargazer)) {install.packages("stargazer")}

```

```{r english_local}
#set local working directory to English
Sys.setlocale("LC_TIME", "English")
```

<!-- %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->

# Introduction

Covid19 had a huge impact on our society. It changed the way we interact on a professional and social level. Home offices, lockdowns, and partially closed stores have had a particularly severe impact on urban centers.

In this paper, we will examine the impact of the pandemic on the number of pedestrians and bicycles in different areas of Zurich.

The city of Zurich automatically collects data on pedestrians and bicyclists through counting loops installed in the ground in different areas of the city. We can get a clear view of the impact of Covid19 on our daily lives by looking at the data of pedestrians and cyclists in 2020 and comparing it to the previous year.

<!-- %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->

<!-- Load data -->

# Data

All the data regarding Zurich are pulled from the official website of the city of Zurich *Open Data Stadt ZÃ¼rich*. The fallowing information are used in this paper:

-   Number of pedestrians and bicycles counted in 2020 and 2019

-   The location of the counting stations.

-   The different *Stadtkreise* and their geodata points.

-   The different districts in Zurich with the corresponding geo data points.

-   A categorization of different areas based on their usage and building development.

The Covid19 data for Switzerland including the categories *cases, deaths, test, hospitalization, and vaccinations* are based on the research of Roser et al. (2020) and pulled from the *Our World in Data* website. In this paper, we will use the smoothed numbers of newly infected people in Switzerland. We decided to use the smoothed numbers since the newly reported cases are directly linked to the working week of medical staff, laboratories, and the Federal Office of Public Health Switzerland (FOPH). As a result, often fewer cases are reported on the weekend and more cases are listed in the beginning of the working week.

Due to the smoothing of the data, the first recorded Covid19 case in our dataset is from 01.03.2020, while the first recorded case actually appeared on the 25.02.2020.

```{r load_covid}
#load covid data
#source : https://ourworldindata.org/coronavirus/country/switzerland?country=~CHE
covid <- read.csv("covid-data.csv", encoding="UTF-8")
covid$date <- as.Date(covid$date,format = "%d.%m.%y")

```

```{r load_zwalks}
#load pedestrian and cyclist data
#source: https://data.stadt-zuerich.ch/dataset/ted_taz_verkehrszaehlungen_werte_fussgaenger_velo
zwalks2020 <- read.csv("2020_verkehrszaehlungen_werte_fussgaenger_velo.csv") #2019
zwalks2019 <- read.csv("2019_verkehrszaehlungen_werte_fussgaenger_velo.csv") #2020

zwalks <- dplyr::union(zwalks2020, zwalks2019)

```

```{r load_kreis}
#load Stadtkreise
#source https://data.stadt-zuerich.ch/dataset/geo_stadtkreise
zkreis <- st_read("./Stadtkreise/stzh.adm_stadtkreise_v.shp")

```

```{r load_zstation}
#load countingstations
#source https://data.stadt-zuerich.ch/dataset/geo_standorte_der_automatischen_fuss__und_vlozaehlungen

zstation <- st_read("./Countingstation/taz.view_eco_standorte.shp")
zstation <- cbind(zstation, st_coordinates(zstation)) #split coordinates into X and Y

```

```{r load_zdistricts}
#Districts
#source: https://data.stadt-zuerich.ch/dataset/ktzh_quartieranalyse
zdistricts <- st_read("./Quartieranalyse/QUARTIERE_F.shp")
```

```{r load_zzones}
#Bauzonen
#sources https://data.stadt-zuerich.ch/dataset/geo_nutzungsplanung___kommunale_bau__und_zonenordnung__bzo__jahresendstand_2020
zzones <- st_read("./Bauzonen/afs.bzo_zone_v.shp")
```

## Preparation

In the initial dataset summarizes the counted pedestrians and cyclists into time frames of 15 minutes. Due to our interest into daily, weekly and monthly changes, we bring the counting data into needed format. Additionally, several adjustment to the data are made for a simpler comparison. The counting stations indicate whether an individual is going into or going out of a center. Since we are interested in the total number of individuals walking or cycling in the area, we summarize them into one number each:

-   Total cyclists
-   Total Pedestrians

Furthermore, we also summarize those two numbers into one single number containing all the measured pedestrians and cyclists at each location:

-   Total People

```{r clean_data}
#extract date from datetime
zwalks['date'] <- as.Date(zwalks$DATUM)

#lower cases column names
zwalks <- setNames(zwalks, tolower(names(zwalks)))

#replace NA with 0
zwalks[is.na(zwalks)] <- 0

#rename columns
zwalks <- zwalks %>%
  rename(datetime = datum)
```

```{r summarize_daily}
#summarize data on a daily basis
zwalks.day <-
  aggregate(zwalks[c("velo_in", "velo_out", "fuss_in", "fuss_out")],
            by = zwalks[c("fk_zaehler", "fk_standort", "date", "ost", "nord")],
            FUN = sum)

#summarize bicycles and pedestrians
zwalks.day['fuss_all'] <- zwalks.day$fuss_in + zwalks.day$fuss_out
zwalks.day['velo_all'] <- zwalks.day$velo_in + zwalks.day$velo_out
zwalks.day['people_all'] <- zwalks.day$velo_all + zwalks.day$fuss_all
```

In a second step, we join the smoothed Covid data to our daily records of cyclists and pedestrians. Before 01.03.2020 there were no covid cases.

```{r zwalks_date}
#add months and weekdays
zwalks.day$year <- format(zwalks.day$date, "%Y")
zwalks.day$month <- format(zwalks.day$date, "%b")
zwalks.day$week <- format(zwalks.day$date, "%W") #create weeks from date
zwalks.day$week <- as.numeric(zwalks.day$week) + 1 #make numeric and add 1 so that it goes from 1 to 53

#weekdays
zwalks.day$weekday <- weekdays(zwalks.day$date)

weekday_order <- c( "Monday", "Tuesday", "Wednesday", "Thursday", "Friday","Saturday","Sunday")
```

```{r join_zwalks_covid}
# overall pedestrians and bicycles
zwalks.agg <-
  aggregate(zwalks.day[c("people_all", "fuss_all", "velo_all")],
            by = zwalks.day[c( "date", "month", "weekday", "week","year")],
            FUN = sum)

# left join zwalks agg and covid on date
zwalks.covid <- zwalks.agg %>%
  left_join(dplyr::select(covid,
                          date,
                          new_cases_smoothed),
            by = "date")

```

```{r agg_monthly}
#replace NA with 0 in covid cases
zwalks.covid[is.na(zwalks.covid)] <- 0

zwalks.covid.month <-
  aggregate(zwalks.covid[c("people_all", "fuss_all", "velo_all","new_cases_smoothed")],
            by = zwalks.covid[c( "year", "month")],
            FUN = sum)



#pivot wide table on months
zwalks.month.wide <- zwalks.covid.month %>%
  dplyr::select(year, people_all, month) %>%
  pivot_wider(names_from = year,
              values_from = people_all)
```

Based on the information of the Swiss Tourism Federation (2021) we additionally the two lockdowns in 2020. The first lockdown from March 16th 2020 until Mai 11. 2020. The second lockdown starting in 22. December 2020 and ongoing in the next year.

```{r}
### define lockdown period
### chronic of lockdowns https://www.stv-fst.ch/de/chronik-coronavirus
lockdown.1 <- seq(as.Date("2020/03/16"), by = "day", length.out = 57)
lockdown.2 <- seq(as.Date("2020/12/22"), by = "day", length.out = 10)

### add lockdown flag to dataset zwalks.covid
zwalks.covid$lockdown <- FALSE
zwalks.covid$lockdown01 <- 0

zwalks.covid[zwalks.covid$date %in% lockdown.1 , ]$lockdown <- TRUE
zwalks.covid[zwalks.covid$date %in% lockdown.1 , ]$lockdown01 <- 1

zwalks.covid[zwalks.covid$date %in% lockdown.2 , ]$lockdown <- TRUE
zwalks.covid[zwalks.covid$date %in% lockdown.1 , ]$lockdown01 <- 1

```

## Counting stations

In the graphic below the counting stations are visualized. The counting stations are not evenly distributed over the twelve districts. The table below shows that district 1 has the most counting stations with a total of 9 and district 7 has no counting stations. We believe that the city of Zurich deliberately selected locations that are highly frequented. Consequently, most counting locations are in the city center or in regional center of Zurich.

A total of 48 different counting location were used to collect the numbers of pedestriand and cyclists during 2019 and 2020.
```{r counting.stations}
#plot Stadtkreise and counting stations
plot.map <- ggplot()+
  geom_sf(data = zkreis, size = 0, color = "black", fill="lightblue")+
  geom_sf(data = zzones, size = 0.25, color = "darkgrey", fill="white")

plot.kreis <- plot.map +
    geom_sf(data = zkreis, size = 1, color = "black", fill= NA )+
    geom_sf_text(data = zkreis, aes(label = knr), colour = "black", size=10)
  
#counting stations  
plot.station <- plot.kreis + geom_point(data = zstation, aes(x=X, y=Y), size = 3, 
                                    shape = 23, fill = "red")
  
plot.station


#join the shape files - left on station
zstation.kreis <- st_join(zstation, zkreis, 
                  join = st_within)


```

```{r table.stations, results="markup"}

# left Stadtkreise
counting.stations <- tibble(District = 1:12) %>% #empty tibble with 12 district
  left_join(zstation.kreis %>% #left join
  group_by(knr) %>%
  summarise(length(unique(abkuerzung))) %>%
  rename("Quantity of Stations" = "length(unique(abkuerzung))"),
    by = c("District" = "knr"))

counting.stations <- counting.stations[0:2]

counting.stations <- counting.stations %>%
  adorn_totals("row") 


options(knitr.kable.NA = "0")

knitr::kable(counting.stations,
             align = "cr",
             caption = "Couting Stations per District") %>%
  kable_styling(bootstrap_options = "striped") %>%
  row_spec(7, color = 'red', bold = TRUE)


```

# Analysis

In the main chapter, we look at the counted pedestrians and cyclists counted in 2019 and 2020 within the city of Zurich. We look at the distribution over time, the difference between the 12 Stadtkreise, the difference between the zones the counting stations are positioned in, and lastly the impact of the two lockdowns.

## Months

First, we take a closer look at the counted pedestrians and cyclists counted together in 2020 and 2019. A comparison of the monthly data is presented below. The top graph below shows the summarized pedestrians and cyclists for each measurement location for the last two years. The two graphs below show the total of measured people for each month in 2019 and 2020 in a direct comparison.

It is obvious that there were more people on the streets in July, August and September in 2020 than in the previous year. We argue that an explanation are the continuous travel restrictions coming from and going to other countries combined with the eased lockdown within Switzerland.Hence, people spent their holidays at home or simply kept working.

```{r month_plots, results="markup"}
#Aggregated Data - Daily 2019/2020
p.months1 <- ggplot(zwalks.covid, aes(x=date, y=people_all)) +
  geom_point(na.rm = TRUE, size = 0.75) +
  xlab("") +
  ylab("Daily per Location ") +
  scale_x_date(
    labels = date_format("%b"),
    breaks = "1 month") + 
  theme(axis.text.x = element_text(angle = 45)) +
  geom_point(aes(colour = factor(year)), size = 2)+
  theme(legend.position = "none")

# 
# p.months2 <- ggplot(zwalks.covid, aes(x=factor(month, level=month.abb), y=people_all)) +
#   geom_point(na.rm = TRUE, size = 0.75) +
#   xlab(" ") +
#   ylab("Total Pedestrians and Cyclists") +
#   theme(axis.text.x = element_text(angle = 45)) +
#   geom_point(aes(colour = factor(year)), size = 4)


p.months3 <- ggplot(zwalks.covid.month, aes(x=factor(month, level=month.abb), y=people_all))+
  geom_line(na.rm = TRUE, size = 0.75) +
  xlab("") +
  ylab("Monthly Total") +
  theme(axis.text.x = element_text(angle = 45)) +
  geom_point(aes(colour = factor(year)), size = 2)+
  labs(color = "Year") 


p.months4 <-ggplot(zwalks.covid.month, aes(x=factor(month, level=month.abb), y=people_all, group=year, colour=year))+
  geom_line(size=2)+
  xlab("") +
  ylab(" ") +
  theme(axis.text.x = element_text(angle = 45))+
  scale_fill_discrete(name = "Year")

plot.months <- ggarrange(
  p.months1,
  ggarrange(
    p.months3,
    p.months4,
    common.legend = TRUE,
    legend = "bottom"
  ),
  nrow = 2
)

plot.months <- annotate_figure(
  plot.months,
  top = text_grob(
    "Pedestirans and cyclists in 2019 and 2020",
    color = "black",
    face = "bold",
    size = 14),
    left = text_grob("Counted Pedestrians and Bicycles", color = "black", rot = 90, hjust=0.5)
  )

plot.months
```

## 

## Covid and Lockdown

In the next step we take a look at how the smoothed covid cases and the counted pedestrians and cyclists are plotted against each other. We only include the counting data from March 1st 2020 until December 31st 2020.

By adding a regression line, we can see that there is a negative correlation between the number of cases and the number of counted people. However, the confidence interval of the trend line is not very accurate and an in existing confidence interval with low covid cases.

The clear right skewing of the data is not a surprise, as we had most of the time below 1000 new covid cases per day. The big variety of recorded people in the street are likely due to whether, temperatures, seasonality but also due to the lockdown. The lockdown is a political decision on not directly triggered or linked to the number of recorded cases.

Additionally, we take a look at the counted people during the two lockdowns and non-lockdown period. The lockdown boxplot clearly indicates that there is a difference between the counted people during lockdown and during non-lockdown, with fewer people on the street during the two periods of lockdown.

In a third look at the relationship between the recorded cyclists and pedestrians and the two lockdowns by applying a logistic regression. It becomes clear, that the lockdown has indeed a negative impact on the number of recorded people on the street.

```{r covid_plots, results="markup"}
###  Boxplot
covid.box <-
  ggplot(
    data = zwalks.covid %>% filter(date >= "2020-03-01"),
    mapping = aes(y = people_all,
                  x = lockdown)
  ) +
  geom_boxplot() +
  geom_hline(yintercept = 0) +
  ylab("People") +
  xlab("Lockdown") +
  ylim(0, 125000)

###  Plot People vs Cases
covid.plot <-
  ggplot(data = zwalks.covid %>% filter(date >= "2020-03-01"),
         aes(y = people_all,
             x = new_cases_smoothed)) +
  geom_point() +
  xlab("New Covid Cases Smoothed") +
  ylab("People") +
  ylim(0, 125000) +
  geom_smooth(method = "lm")

### Logistic regression
zwalks.covid.glm <-
  glm(lockdown ~  people_all, family = "binomial",
      data = zwalks.covid %>% filter(date >= "2020-03-01"))

stargazer(zwalks.covid.glm, title="Regression Results", align=TRUE)


### Plot the Logistic regression
covid.lr1 <- ggplot(data = zwalks.covid %>% filter(date >= "2020-03-01"),
                   mapping = aes(y = lockdown01,
                                 x = people_all)) +
  xlab("Pedestrians and Cyclists") +
  ylab("Lockdown")+
  geom_point() +
  geom_smooth(
    method = "glm",
    se = FALSE,
    method.args = list(family = "binomial")
  )



p.covid <- ggarrange(covid.plot,
                     covid.box,
                     covid.lr1,
                     align = "hv",
                     nrow = 3)


p.covid <- annotate_figure(
  p.covid,
  top = text_grob(
    "Pedestrians and cyclists in 2020 compared to covid cases and lockdown",
    color = "black",
    face = "bold"
  )
)

p.covid

```
```{r covid_glm}
stargazer(zwalks.covid.glm, title="Regression Results", type = 'text')
```


# Conclusion

With the mostly visual approach, we could show that the behavior of the people in Zurich changed compared to the previous year. While the impact of the lockdown on the counted people on the streets is no surprise, the clear increase during the summer months was rather unexpected.

The most outstanding part of our visual comparison was the increase of counted cyclists almost through the whole year.

This paper did primarily took a visually based comparison of the number of pedestrians and cyclists in 2019 and 2020 respectively during the two lockdowns in them. For further research, it would be necessary to quantify this identified impact statistically. A longer time series would be necessary to identify and address seasonality and trends in order to identify the impact of covid on the counted people.
